

library 'shared-lib-int@main'
//@Library("shared-lib-int") _
import hudson.*;

//dict
//generic-build("snykToken","telegramToken","polybot","dockerhub")


pipeline {

    options {
        buildDiscarder(logRotator(daysToKeepStr: '10', numToKeepStr: '10'))
        disableConcurrentBuilds()
        timestamps()
        //retry(2)
        timeout(time: 3, unit: 'MINUTES')
    }
    agent {
       kubernetes {

         defaultContainer 'jenkins-agent'
         yaml '''
           apiVersion: v1
           kind: Pod
           metadata:
             labels:
               some-label: jenkins-eks-pod
           spec:
             serviceAccountName: jenkins-admin
             volumes:
             - name: jenkinsagent-pvc
               hostPath:
                 path: /var/run/docker.sock
             containers:
             - name: jenkins-agent
               image: shaniben/shani-repo:jenkins
               imagePullPolicy: Always
               volumeMounts:
               - name: jenkinsagent-pvc
                 mountPath: /var/run/docker.sock
               tty: true
             securityContext:
               allowPrivilegeEscalation: false
               runAsUser: 0
        '''
                }
             }



//    agent{
//        docker{
//              image 'jenkins-agent:latest'
//              args  '--user root -v /var/run/docker.sock:/var/run/docker.sock'
//               }
//    }


    //insert credential to environment variable
    //insert to specific environment variable (must to this name: SNYK_TOKEN) my snyk's token
    environment{
        SNYK_TOKEN=credentials('snykToken')
    }



    stages {
        stage('Test') {
           parallel {
                   stage('pytest'){
                        steps{
                          catchError(message:'pytest ERROR',buildResult:'UNSTABLE',stageResult:'UNSTABLE'){
                            withCredentials([file(credentialsId: 'telegramToken', variable: 'TOKEN_FILE')]) {
                              sh "cp ${TOKEN_FILE} .telegramToken"
                              sh 'pip3 install -r requirements.txt'
                              sh 'python3 -m pytest --junitxml results.xml tests/*.py'
                              }
                           }
                        }
                    }

           stage('pylint') {
                         steps {
                         catchError(message:'pylint ERROR',buildResult:'UNSTABLE',stageResult:'UNSTABLE'){
                              script {
                                     log.info 'Starting'
                                     log.warning 'Nothing to do!'
                                     sh "python3 -m pylint *.py || true"
                                     }
                                  }
                               }
                            }
                        }
                    }







        //build with tag to dockerHub repo
        //stage('Build Bot app') {
        //     steps {
        //           sh "docker build -t shaniben/shani-repo:poly-bot-${env.BUILD_NUMBER} . "

        //           }
        //         }

        //build with tag to ECR repo
        stage('Build Bot app') {
             steps {
                  sh 'docker build -t shani-ecr-repo:poly-bot-""$BUILD_ID"" .'
                  sh 'docker tag shani-ecr-repo:poly-bot-${env.BUILD_NUMBER} 019273956931.dkr.ecr.eu-west-1.amazonaws.com/shani-ecr-repo:poly-bot-""$BUILD_ID""'

                   }
                 }







        //snyk test for an image which saved in DockerHub
        //stage('snyk test - Bot image') {
        //    steps {
        //        sh "snyk container test --severity-threshold=critical --policy-path=PolyBot/.snyk shaniben/shani-repo:poly-bot-${env.BUILD_NUMBER} --file=Dockerfile || true"
        //          }
        //       }


        //snyk test for an image which saved in ECR
        stage('snyk test - Bot image') {
            steps {
                sh "snyk container test --severity-threshold=critical --policy-path=PolyBot/.snyk 019273956931.dkr.ecr.eu-west-1.amazonaws.com/shani-ecr-repo:poly-bot-${env.BUILD_NUMBER} --file=Dockerfile || true"
                  }
               }






        //push DockerHub
        //stage('push image to DockerHub repo') {
        //    steps {
        //       withCredentials([usernamePassword(credentialsId: 'dockerhub', passwordVariable: 'pass', usernameVariable: 'user')]){
        //           sh "docker login --username $user --password $pass"
        //            sh "docker push shaniben/shani-repo:poly-bot-${env.BUILD_NUMBER}"



        //      }
        //    }
        // }

        //push ECR
        stage('push image to ECR repo') {
            steps {
               withEnv(["AWS_ACCESS_KEY_ID=$(env.AWS_ACCESS_KEY_ID)" , "AWS_SECRET_ACCESS_KEY=$(env.AWS_SECRET_ACCESS_KEY)" , "AWS_REGION=$(env.AWS_REGION)"]){
                    sh "docker login -u AWS -p $(aws ecr get-login-password --region eu-west-1) 019273956931.dkr.ecr.eu-west-1.amazonaws.com"
                   // sh "docker push 019273956931.dkr.ecr.eu-west-1.amazonaws.com/shani-ecr-repo:poly-bot-${env.BUILD_NUMBER}"
                    sh 'docker push 019273956931.dkr.ecr.eu-west-1.amazonaws.com/shani-ecr-repo:poly-bot-""$BUILD_ID""'
               }
            }
         }

    }//close stages






        post{
          always{
            junit allowEmptyResults: true, testResults: 'results.xml'
            // sh "docker rmi shaniben/shani-repo:poly-bot-${env.BUILD_NUMBER}"
            }

       }



}//close pipeline

